<!-- src/main/resources/static/oauth2.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>OAuth2 Test</title>
    <!-- Vue 3 + Axios CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="app">
    <!-- ë¡œê·¸ì¸ ì „ -->
    <button v-if="!isLoggedIn" @click="loginWithGoogle">
        <!--        ğŸ” Google ë¡œê·¸ì¸-->
        <img src="/images/web_light_rd_ctn@1x.png" alt="google Image">
    </button>

    <br>

    <button v-if="!isLoggedIn" @click="loginWithKakao">
        <!--        ğŸ” KaKao ë¡œê·¸ì¸-->
        <img src="/images/kakao_login_medium_narrow.png" alt="My Image">
    </button>


    <!-- ë¡œê·¸ì¸ í›„ -->
    <div v-else>
        <p>ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, {{ user.name }}</p>
        <p>ì´ë©”ì¼: {{ user.email }}</p>
        <button @click="callProtected">ë³´í˜¸ëœ API í˜¸ì¶œ</button>
        <pre v-if="protected">{{ protected }}</pre>
    </div>

    <!-- ì—ëŸ¬ ì²˜ë¦¬ -->
    <p v-if="error" style="color: red">{{ error }}</p>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isLoggedIn: false,
                user: {},
                protected: null,
                error: null,
            };
        },
        methods: {
            // 1) êµ¬ê¸€ OAuth2 ë¡œê·¸ì¸ ì‹œì‘
            loginWithGoogle() {
                // ì—¬ê¸°ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì—´ì–´ë‘” ì—”ë“œí¬ì¸íŠ¸
                window.location.href = '/oauth2/authorization/google';
            },
            // 1) êµ¬ê¸€ OAuth2 ë¡œê·¸ì¸ ì‹œì‘
            loginWithKakao() {
                // ì—¬ê¸°ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì—´ì–´ë‘” ì—”ë“œí¬ì¸íŠ¸
                window.location.href = '/oauth2/authorization/kakao';
            },

            // 2) ë¡œê·¸ì¸ ì„±ê³µ(í˜¹ì€ ì—ëŸ¬) í›„ ì´ ì•±ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëë‹¤ê³  ê°€ì •
            async fetchProfile() {
                try {
                    // ì¿ í‚¤ ê¸°ë°˜ ì¸ì¦: withCredentials ê°€ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤
                    const res = await axios.get('/api/auth/me', {
                        withCredentials: true
                    });
                    this.user = res.data;
                    this.isLoggedIn = true;
                } catch (e) {
                    this.isLoggedIn = false;
                    // ë§Œì•½ redirect ì‹œ ?error ê°€ ë¶™ì–´ì™”ë‹¤ë©´
                    if (window.location.search.includes('error')) {
                        this.error = 'OAuth2 ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    }
                }
            },

            // 3) ë³´í˜¸ëœ API ë¥¼ í˜¸ì¶œí•´ ë³´ê¸°
            async callProtected() {
                try {
                    const res = await axios.get('/api/auth/protected', {
                        withCredentials: true
                    });
                    this.protected = JSON.stringify(res.data, null, 2);
                } catch (e) {
                    this.protected = `Error ${e.response.status}: ${e.response.data}`;
                }
            }
        },
        mounted() {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³§ë°”ë¡œ í”„ë¡œí•„ í™•ì¸ â†’ ë¡œê·¸ì¸ ì—¬ë¶€ íŒë‹¨
            this.fetchProfile();
        }
    }).mount('#app');
</script>
</body>
</html>